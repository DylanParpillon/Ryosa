<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RyosaChii Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        ryosa: {
                            50: '#f3e8ff',
                            100: '#d8b4fe',
                            400: '#a855f7',
                            500: '#9146FF', // Twitch Purple
                            600: '#7c3aed',
                            800: '#5b21b6',
                            900: '#2e1065',
                            dark: '#0f0e17',
                            card: '#16161e',
                            hover: '#1e1e2a'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        body {
            background-color: #0d0d12;
            color: #e2e8f0;
        }

        .clean-card {
            background-color: #16161e;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Scrollbar clean */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d0d12;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d2d3a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9146FF;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden" x-data="dashboard()">

    <!-- Header -->
    <header class="h-16 bg-[#16161e] border-b border-white/5 flex items-center justify-between px-6 z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-ryosa-500 flex items-center justify-center shadow-lg shadow-ryosa-500/20">
                <i class="fa-solid fa-robot text-white text-sm"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-white">
                Ryosa<span class="text-ryosa-400">Chii</span>
            </h1>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-semibold text-green-400 uppercase tracking-wide">Online</span>
            </div>
        </div>
    </header>

    <!-- Content Grid -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Main Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth">
            <div class="max-w-5xl mx-auto space-y-8">

                <!-- Intro -->
                <div>
                    <h2 class="text-3xl font-bold text-white mb-2">Tableau de Bord</h2>
                    <p class="text-gray-400">Gère tes commandes et alertes en direct.</p>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="clean-card rounded-xl p-5 border-l-4 border-l-ryosa-500">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-1">Status</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-white">Actif</span>
                            <i class="fa-solid fa-server text-ryosa-500/50"></i>
                        </div>
                    </div>
                    <div class="clean-card rounded-xl p-5 border-l-4 border-l-pink-500">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-1">Commandes</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-white" x-text="commands.length"></span>
                            <i class="fa-solid fa-terminal text-pink-500/50"></i>
                        </div>
                    </div>
                    <div class="clean-card rounded-xl p-5 border-l-4 border-l-blue-500">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-1">Alerte Chat</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-white" x-text="alerts.enabled ? 'ON' : 'OFF'"></span>
                            <i class="fa-solid fa-bell text-blue-500/50"></i>
                        </div>
                    </div>
                </div>

                <!-- Custom Commands -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-bolt text-ryosa-400"></i>
                            Commandes Perso
                        </h3>
                        <button @click="showAddModal = true"
                            class="bg-ryosa-600 hover:bg-ryosa-500 text-white px-4 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Ajouter
                        </button>
                    </div>

                    <div class="clean-card rounded-xl overflow-hidden min-h-[300px]">
                        <template x-if="loading">
                            <div class="flex items-center justify-center h-64 text-gray-500">
                                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                            </div>
                        </template>

                        <div x-show="!loading && commands.length === 0"
                            class="flex flex-col items-center justify-center h-64 text-gray-600">
                            <i class="fa-regular fa-folder-open text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm">Aucune commande configurée.</p>
                        </div>

                        <ul x-show="!loading && commands.length > 0" class="divide-y divide-white/5">
                            <template x-for="cmd in commands" :key="cmd.name">
                                <li
                                    class="p-4 hover:bg-ryosa-hover transition group flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-1.5">
                                            <span
                                                class="font-mono font-bold text-ryosa-300 bg-ryosa-500/10 px-2 py-0.5 rounded text-sm"
                                                x-text="'!' + cmd.name"></span>
                                        </div>
                                        <p class="text-gray-400 text-sm" x-text="cmd.response"></p>
                                    </div>
                                    <button @click="deleteCommand(cmd.name)"
                                        class="text-gray-500 hover:text-red-400 hover:bg-red-500/10 p-2 rounded transition opacity-0 group-hover:opacity-100">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </li>
                            </template>
                        </ul>
                    </div>
                </section>

                <!-- Configuration Auto-Message -->
                <section>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-gear text-gray-400"></i>
                        Configuration Alertes
                    </h3>
                    <div class="clean-card rounded-xl p-6">
                        <form @submit.prevent="updateAlerts" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-1 space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Fréquence
                                        (secondes)</label>
                                    <input type="number" x-model.number="alerts.interval"
                                        class="w-full bg-[#0d0d12] border border-white/10 rounded-lg px-4 py-2.5 text-sm focus:border-ryosa-500 outline-none transition text-white">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Seuil min.
                                        messages</label>
                                    <input type="number" x-model.number="alerts.threshold"
                                        class="w-full bg-[#0d0d12] border border-white/10 rounded-lg px-4 py-2.5 text-sm focus:border-ryosa-500 outline-none transition text-white">
                                </div>
                            </div>
                            <div class="col-span-1 flex flex-col">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Contenu du
                                    message</label>
                                <textarea x-model="alerts.text"
                                    class="flex-1 w-full bg-[#0d0d12] border border-white/10 rounded-lg px-4 py-3 text-sm focus:border-ryosa-500 outline-none transition resize-none text-white leading-relaxed"></textarea>
                            </div>
                            <div class="col-span-1 md:col-span-2 flex justify-end">
                                <button type="submit"
                                    class="bg-gray-700 hover:bg-gray-600 text-white font-medium px-6 py-2 rounded-lg transition text-sm">
                                    Sauvegarder les réglages
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

            </div>
        </main>

        <!-- Right Sidebar: Chat (Fixed) -->
        <aside class="w-96 bg-[#000000] border-l border-white/5 hidden xl:flex flex-col shrink-0">
            <div class="h-10 bg-[#16161e] flex items-center px-4 border-b border-white/5">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Chat en direct</span>
            </div>
            <!-- Twitch Chat Embed -->
            <div class="flex-1 relative">
                <!-- IMPORTANT: parent=localhost pour le dev, ajouter ton domaine en prod -->
                <!-- Remplacer 'lacabanevirtuelle' par le vrai nom de chaine si différent -->
                <iframe
                    src="https://www.twitch.tv/embed/lacabanevirtuelle/chat?parent=localhost&parent=127.0.0.1&darkpopout"
                    class="absolute inset-0 w-full h-full" frameborder="0">
                </iframe>
            </div>
        </aside>

    </div>

    <!-- Modal Add Command -->
    <div x-show="showAddModal" style="display: none;" x-transition.opacity
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">

        <div @click.away="showAddModal = false"
            class="bg-[#16161e] border border-white/10 rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">Nouvelle Commande</h3>

            <form @submit.prevent="addCommand" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">Déclencheur</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-500 font-bold">!</span>
                        <input type="text" x-model="newCmd.name" placeholder="discord" required
                            class="w-full pl-6 bg-[#0d0d12] border border-white/10 rounded-lg px-3 py-2.5 text-sm focus:border-ryosa-500 outline-none text-white">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">Réponse du bot</label>
                    <textarea x-model="newCmd.response" placeholder="Votre message ici..." required rows="3"
                        class="w-full bg-[#0d0d12] border border-white/10 rounded-lg px-3 py-2.5 text-sm focus:border-ryosa-500 outline-none text-white resize-none"></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" @click="showAddModal = false"
                        class="flex-1 py-2.5 rounded-lg text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition">
                        Annuler
                    </button>
                    <button type="submit"
                        class="flex-1 bg-ryosa-600 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-ryosa-500 transition">
                        Créer
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Script Logic (Identique, pas de changement backend requis) -->
    <script>
        function dashboard() {
            return {
                loading: true,
                commands: [],
                alerts: {
                    interval: 300,
                    threshold: 5,
                    text: '',
                    enabled: false
                },
                showAddModal: false,
                newCmd: { name: '', response: '' },

                async init() {
                    await this.fetchCommands();
                    await this.fetchAlerts();
                    this.loading = false;
                },

                async fetchCommands() {
                    try {
                        const res = await fetch('/api/commands');
                        this.commands = await res.json();
                    } catch (e) { console.error(e); }
                },

                async addCommand() {
                    try {
                        const res = await fetch('/api/commands', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newCmd)
                        });
                        if (res.ok) {
                            await this.fetchCommands();
                            this.newCmd = { name: '', response: '' };
                            this.showAddModal = false;
                        }
                    } catch (e) { console.error(e); }
                },

                async deleteCommand(name) {
                    if (!confirm('Supprimer !' + name + ' ?')) return;
                    try {
                        const res = await fetch('/api/commands', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name })
                        });
                        if (res.ok) { await this.fetchCommands(); }
                    } catch (e) { console.error(e); }
                },

                async fetchAlerts() {
                    try {
                        const res = await fetch('/api/alerts');
                        this.alerts = await res.json();
                    } catch (e) { console.error(e); }
                },

                async updateAlerts() {
                    try {
                        const res = await fetch('/api/alerts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.alerts)
                        });
                        if (res.ok) { alert('Réglages sauvegardés.'); }
                    } catch (e) { console.error(e); }
                }
            }
        }
    </script>
</body>

</html>